name: CI/CD - ToDo App (minimal)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: docker.io
  API_IMAGE_NAME: todo-api

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Crear docker-compose.prod.yml
      run: |
        cat > docker-compose.prod.yml << EOF
        version: '3.8'
        services:
          redis:
            image: redis:7-alpine
            restart: unless-stopped
            ports:
              - "6379:6379"
            networks:
              - todo-network

          api:
            image: ${{ secrets.DOCKER_USERNAME }}/${{ env.API_IMAGE_NAME }}:latest
            restart: unless-stopped
            ports:
              - "3000:3000"
            environment:
              - PORT=3000
              - REDIS_URL=redis://redis:6379
            depends_on:
              - redis
            networks:
              - todo-network

          frontend:
            image: ${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:latest
            restart: unless-stopped
            ports:
              - "8080:8080"
            environment:
              - PORT=8080
            depends_on:
              - api
            networks:
              - todo-network

        networks:
          todo-network:
            driver: bridge
        EOF

    - name: Mostrar información de despliegue
      run: |
        echo "🚀 Imágenes construidas y publicadas:"
        echo "   - API: ${{ secrets.DOCKER_USERNAME }}/${{ env.API_IMAGE_NAME }}:latest"
        echo "   - Frontend: ${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:latest"
        echo ""
        echo "📋 Para desplegar en producción:"
        echo "   docker-compose -f docker-compose.prod.yml up -d"